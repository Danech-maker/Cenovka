<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8" />
  <title>Cenová nabídka</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <style>
    /* Jednoduché základní styly */
    body { font-family: Arial, sans-serif; max-width: 900px; margin: auto; padding: 10px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ddd; padding: 6px; }
    th { background-color: #f0f0f0; }
    input[type="text"], input[type="number"], input[type="email"] {
      width: 100%; box-sizing: border-box; padding: 4px;
    }
    button { cursor: pointer; padding: 6px 10px; margin-top: 10px; }
  </style>
</head>
<body>
  <h1>Cenová nabídka</h1>

  <section>
    <h2>Firma (prodávající)</h2>
    <label>IČ firmy: <input id="icoFirmy" maxlength="8" /></label><br/>
    <label>Název firmy: <input id="nazevFirmy" /></label><br/>
    <label>Adresa firmy: <input id="adresaFirmy" /></label><br/>
    <label>Email firmy: <input id="emailFirmy" type="email" /></label><br/>
    <label>Telefon firmy: <input id="telefonFirmy" /></label>
  </section>

  <section>
    <h2>Zákazník</h2>
    <label>IČ zákazníka: <input id="icoZakaznika" maxlength="8" /></label><br/>
    <label>Název zákazníka: <input id="zakaznikNazev" /></label><br/>
    <label>Adresa zákazníka: <input id="zakaznikAdresa" /></label><br/>
    <label>Email zákazníka: <input id="zakaznikEmail" type="email" /></label><br/>
    <label>Telefon zákazníka: <input id="zakaznikTelefon" /></label>
  </section>

  <section>
    <h2>Položky</h2>
    <table>
      <thead>
        <tr>
          <th>Popis</th>
          <th>Množství</th>
          <th>Cena za ks (Kč)</th>
          <th>Celkem</th>
          <th></th>
        </tr>
      </thead>
      <tbody id="items"></tbody>
    </table>
    <button id="addItem">Přidat položku</button>
  </section>

  <section>
    <label>Sleva (%) <input id="sleva" type="number" min="0" max="100" value="0" /></label><br/>
    <label>Poznámka:<br/>
      <textarea id="poznamka" rows="3" style="width:100%"></textarea>
    </label>
  </section>

  <section>
    <h2>Souhrn</h2>
    <p>Celkem bez DPH: <span id="celkemBezDph">0 Kč</span></p>
    <p>Sleva: <span id="slevaCastka">0 Kč</span></p>
    <p>Celkem po slevě: <span id="celkemPoSleve">0 Kč</span></p>
  </section>

  <section>
    <button onclick="exportPDF()">Exportovat do PDF</button>
    <input type="file" id="loadInput" accept=".json" />
  </section>

<script>
  // --- Přidání nové položky ---
  function addItemRow() {
    const tbody = document.getElementById("items");
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><input type="text" class="popis" /></td>
      <td><input type="number" class="qty" min="0" value="0" /></td>
      <td><input type="number" class="price" min="0" value="0" /></td>
      <td class="total">0 Kč</td>
      <td><button class="remove">✕</button></td>
    `;
    tbody.appendChild(tr);
  }

  // --- Aktualizace cen ---
  function updateTotals() {
    const rows = document.querySelectorAll("#items tr");
    let celkem = 0;
    rows.forEach(row => {
      const qty = parseFloat(row.querySelector(".qty").value) || 0;
      const price = parseFloat(row.querySelector(".price").value) || 0;
      const total = qty * price;
      row.querySelector(".total").textContent = total.toLocaleString("cs-CZ") + " Kč";
      celkem += total;
    });
    document.getElementById("celkemBezDph").textContent = celkem.toLocaleString("cs-CZ") + " Kč";

    const slevaProc = parseFloat(document.getElementById("sleva").value) || 0;
    const slevaCastka = celkem * slevaProc / 100;
    document.getElementById("slevaCastka").textContent = slevaCastka.toLocaleString("cs-CZ") + " Kč";

    const poSleve = celkem - slevaCastka;
    document.getElementById("celkemPoSleve").textContent = poSleve.toLocaleString("cs-CZ") + " Kč";
  }

  // --- Sběr dat pro uložení ---
  function collectOfferData() {
    const items = [];
    document.querySelectorAll("#items tr").forEach(row => {
      items.push({
        popis: row.querySelector(".popis").value.trim(),
        mnozstvi: parseFloat(row.querySelector(".qty").value) || 0,
        cena: parseFloat(row.querySelector(".price").value) || 0,
      });
    });
    return {
      firma: {
        ico: document.getElementById("icoFirmy").value.trim(),
        nazev: document.getElementById("nazevFirmy").value.trim(),
        adresa: document.getElementById("adresaFirmy").value.trim(),
        email: document.getElementById("emailFirmy").value.trim(),
        telefon: document.getElementById("telefonFirmy").value.trim(),
      },
      zakaznik: {
        ico: document.getElementById("icoZakaznika").value.trim(),
        nazev: document.getElementById("zakaznikNazev").value.trim(),
        adresa: document.getElementById("zakaznikAdresa").value.trim(),
        email: document.getElementById("zakaznikEmail").value.trim(),
        telefon: document.getElementById("zakaznikTelefon").value.trim(),
      },
      polozky: items,
      sleva: parseFloat(document.getElementById("sleva").value) || 0,
      poznamka: document.getElementById("poznamka").value.trim(),
    };
  }

  // --- Načtení dat z JSON ---
  document.getElementById("loadInput").addEventListener("change", (e) => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = () => {
      try {
        const data = JSON.parse(reader.result);
        loadOfferData(data);
      } catch {
        alert("Chybný formát souboru.");
      }
    };
    reader.readAsText(file);
    e.target.value = "";
  });

  // --- Naplnění formuláře daty ---
  function loadOfferData(data) {
    if (!data) return;

    if (data.firma) {
      document.getElementById("icoFirmy").value = data.firma.ico || "";
      document.getElementById("nazevFirmy").value = data.firma.nazev || "";
      document.getElementById("adresaFirmy").value = data.firma.adresa || "";
      document.getElementById("emailFirmy").value = data.firma.email || "";
      document.getElementById("telefonFirmy").value = data.firma.telefon || "";
    }

    if (data.zakaznik) {
      document.getElementById("icoZakaznika").value = data.zakaznik.ico || "";
      document.getElementById("zakaznikNazev").value = data.zakaznik.nazev || "";
      document.getElementById("zakaznikAdresa").value = data.zakaznik.adresa || "";
      document.getElementById("zakaznikEmail").value = data.zakaznik.email || "";
      document.getElementById("zakaznikTelefon").value = data.zakaznik.telefon || "";
    }

    const tbody = document.getElementById("items");
    tbody.innerHTML = "";
    if (data.polozky && data.polozky.length) {
      data.polozky.forEach((p) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td><input type="text" class="popis" value="${p.popis || ""}" /></td>
          <td><input type="number" class="qty" min="0" value="${p.mnozstvi || 0}" /></td>
          <td><input type="number" class="price" min="0" value="${p.cena || 0}" /></td>
          <td class="total">0 Kč</td>
          <td><button class="remove">✕</button></td>
        `;
        tbody.appendChild(tr);
      });
    } else {
      addItemRow();
    }

    document.getElementById("sleva").value = data.sleva || 0;
    document.getElementById("poznamka").value = data.poznamka || "";
    updateTotals();
  }

  // --- Export do PDF ---
  function exportPDF() {
    const element = document.body;
    const opt = {
      margin: 0.5,
      filename: "cenova_nabidka.pdf",
      image: { type: "jpeg", quality: 0.98 },
      html2canvas: { scale: 2 },
      jsPDF: { unit: "in", format: "a4", orientation: "portrait" },
    };
    html2pdf().set(opt).from(element).save();
  }

  // --- Odebrání položky ---
  document.getElementById("items").addEventListener("click", (e) => {
    if (e.target.classList.contains("remove")) {
      e.target.closest("tr").remove();
      updateTotals();
    }
  });

  // --- Přidání položky ---
  document.getElementById("addItem").addEventListener("click", () => {
    addItemRow();
  });

  // --- Aktualizace cen při změně ---
  document.getElementById("items").addEventListener("input", (e) => {
    if (
      e.target.classList.contains("qty") ||
      e.target.classList.contains("price")
    ) {
      updateTotals();
    }
  });

  document.getElementById("sleva").addEventListener("input", updateTotals);

  // --- Načtení dat z ARES podle IČ ---
  async function fetchAresData(ico, targetPrefix) {
    if (!ico || ico.length !== 8) {
      return;
    }

    const url = `https://wwwinfo.mfcr.cz/cgi-bin/ares/darv_bas.cgi?ico=${ico}`;
    const proxyUrl = "https://api.allorigins.win/get?url=" + encodeURIComponent(url);

    try {
      const response = await fetch(proxyUrl);
      if (!response.ok) throw new Error("Chyba při načítání dat z ARES.");
      const data = await response.json();

      const parser = new DOMParser();
      const xmlDoc = parser.parseFromString(data.contents, "text/xml");

      const companyName = xmlDoc.querySelector("OF")?.textContent || "";
      const street = xmlDoc.querySelector("AA > UC")?.textContent || "";
      const buildingNumber = xmlDoc.querySelector("AA > CD")?.textContent || "";
      const city = xmlDoc.querySelector("AA > N")?.textContent || "";
      const postalCode = xmlDoc.querySelector("AA > PSC")?.textContent || "";

      if (!companyName) {
        alert(`Firma se IČ ${ico} nebyla nalezena.`);
        return;
      }

      document.getElementById(`${targetPrefix}Nazev`).value = companyName;
      document.getElementById(`${targetPrefix}Adresa`).value = `${street} ${buildingNumber}, ${postalCode} ${city}`;
    } catch (error) {
      alert("Chyba při načítání dat z ARES: " + error.message);
    }
  }

  // --- Event listener na změnu IČ firmy ---
  document.getElementById("icoFirmy").addEventListener("change", (e) => {
    fetchAresData(e.target.value.trim(), "nazevFirmy" in document.getElementById("nazevFirmy") ? "nazevFirmy" : "nazevFirmy");
    fetchAresData(e.target.value.trim(), "firmy");
  });
  document.getElementById("icoFirmy").addEventListener("change", (e) => {
    fetchAresData(e.target.value.trim(), "nazevFirmy");
  });

  // --- Event listener na změnu IČ zákazníka ---
  document.getElementById("icoZakaznika").addEventListener("change", (e) => {
    fetchAresData(e.target.value.trim(), "zakaznik");
  });

  // --- Inicializace ---
  addItemRow();
  updateTotals();
</script>
</body>
</html>
